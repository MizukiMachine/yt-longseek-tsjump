# Chrome拡張「YouTube 長時間シーク & 現地時刻ジャンプ」要件&仕様

## 1. 目的 ✅ **実装完了**
YouTube ライブ配信（特に24時間配信）や長尺動画で、長時間単位の巻き戻し/早送りや、現地（オランダ）時刻を指定してその瞬間へジャンプできるようにする

**✅ 解決済み**: 従来の3つの問題（60分系統的ズレ・1-2分精度エラー・累積ドリフト）を**キャリブレーション方式**で完全解決

対象例：DVR有効live配信


## 2. 機能

### (A) 長時間シーク（早送り・巻き戻し）
- デフォルト：±10分、±60分（Chrome拡張機能4コマンド制限のため）
- キーボードショートカットで実行
  - (実装済み)
    - Alt+Shift+Q → -60分
    - Alt+Shift+A → -10分
    - Alt+Shift+W → +60分
    - Alt+Shift+S → +10分
  - ポイント
    - Q/A = 戻る系、W/S = 進む系でペア配置
    - Chrome拡張機能の4コマンド制限により±30分は除外
  - ユーザーは `chrome://extensions/shortcuts` で変更可能（手動設定が必要）
- 動作範囲は `video.seekable.start()` ～ `video.seekable.end()` にクランプ
- **ライブエッジ保護**：終了3秒前で自動停止（動画終了防止）
- DVR無効時は巻き戻し不可、ライブエッジ（最新位置）より先へは進めない
- 広告中は動作しない（通知表示）
- **詳細なエラー情報**：動画未検出、シーク不可、範囲外クランプ理由を提供



### (B) 「現地時刻ジャンプ」機能 ✅ **実装完了**
- **アクセス方法**
  - **Jumpボタン**: YouTubeコントロールバー（ギア/字幕ボタン横）に配置した「Jump」ボタン
  - **キーボードショートカット**: `Alt+Shift+J` でドラッグ可能カードを表示
- 入力欄に **オランダ（Europe/Amsterdam）のローカル時刻**を入力
  - 対応形式：`HH:mm`、`HH:mm:ss`（コロン区切り）、`HHmm`、`HHmmss`（コロンなし）
  - 例：`06:00`、`14:30:45`、`0600`、`143045` 全て対応
- 実行すると、現地時刻に対応する再生位置へジャンプ
- **✅ キャリブレーション方式実装**: 6秒間サンプリング+メディアン値による高精度計算
- **✅ DST（サマータイム）対応**：`Intl.DateTimeFormat`による正確なタイムゾーン変換
- **✅ 実装済み計算式（キャリブレーション方式）**
  1. **初回キャリブレーション**: `calibratedOffset = median(epochTime - seekable.end())`
  2. **時刻解析**: `parseTimeToSeconds(inputTime)` → 今日の日付と結合
  3. **UTC変換**: `netherlandsTimeToEpoch(targetDate)` でepoch秒取得
  4. **メディア時間計算**: `targetMediaTime = targetEpoch - calibratedOffset`
  5. **DVR範囲内シーク**: `seekToAbsoluteTime(targetMediaTime)`
- **✅ エラーハンドリング実装**
  - 詳細なエラー情報（TimeJumpResult interface）
  - 動画要素不存在・時刻フォーマット・キャリブレーション失敗の包括的処理
  - コンソールログによる成功・失敗・オフセット情報表示
- **✅ 解決済み問題**
  - **60分系統的ズレ**: キャリブレーション方式で完全解決
  - **1-2分精度エラー**: メディアンサンプリングで解決
  - **累積ドリフト**: リアルタイムオフセット計算で排除


## 3. 初期開発方針（タイムゾーン仕様）
- 初期はオランダ固定で開発
  - 実装・説明がシンプルになり、リリースまでの速度が上がる
- 要望や利用状況を見て、将来的にタイムゾーン選択機能を追加可能
  - 他国の配信やイベントにも対応し、汎用化できる
  - タイムゾーン一覧・DST対応を拡張する設計を視野に入れる


## 4. UI・操作仕様
- **Jumpボタン**（主要アクセス）
  - 位置：YouTubeコントロールバーの右端（設定・字幕ボタン横）
  - スタイル：YouTube標準ボタンと統一されたデザイン
  - クリックでドラッグ可能カードを表示・非表示
- **ドラッグ可能カード**（入力UI）
  - 初回表示位置：Jumpボタンの上方・右寄り（コントロールバー沿い）
  - **ドラッグ移動**：自由にプレイヤー内を移動可能、位置は `localStorage` に保存
  - **ピン留め機能**：
    - ON = 常時表示（自動フェードなし）
    - OFF = 無操作数秒後に半透明化→非表示、マウス移動で再表示
  - **字幕配慮**：初回スポーン時に下中央の字幕帯を避ける安全マージン（`bottom ≥ 90px`）
  - **フルスクリーン対応**：`.html5-video-player` 配下に設置、画面変更時に自動クランプ
- **キーボード操作**
  - `Alt+Shift+J`：カード表示・非表示、入力フィールドへフォーカス
  - `Enter`：時刻ジャンプ実行
  - `Esc`：カードを閉じる
  - 外側クリック：未ピン時のみカードを閉じる
- **アクセシビリティ**
  - カードに `role="dialog"`、`aria-label` 設定
  - Tab移動順の適切化、閉じた際の動画フォーカス復帰

## 5. オプション設定
- 長時間シークの分数（自由設定）
- 「現地時刻ジャンプ」機能の既定動作
  - 未来入力時の自動「昨日」切替オン/オフ
  - 入力形式（HH:mm、HH:mm:ss、HHmm、HHmmss対応済み）


## 6. 対象サイトと権限（最小権限設計）
```json
"permissions": ["commands", "storage", "scripting", "activeTab"],
"host_permissions": [
  "https://www.youtube.com/*",
  "https://www.youtube-nocookie.com/*"
]
```

* `<all_urls>` は使わない
* 必要な場合のみ追加（例：モバイル版YouTube、埋め込みプレイヤー）


## 7. セキュリティ／審査対策

* **CSP準拠**

  * JSは外部ファイル化（インライン禁止、`eval`禁止）
  * ライブラリは同梱（CDN直読み禁止）
* 外部API・データ送信なし（完全ローカル動作）
* 広告スキップやDVR無効回避など、YouTubeの制限を迂回する機能は実装しない
* ストア説明に「YouTube™ 非公式ツール」であることを明記


## 8. 動作確認チェックリスト

### ✅ **実装完了項目**
1. **VODでの±シーク**（端でクランプされる）
2. **DVR有効ライブ**：巻き戻し可／エッジ3秒前まで進み可
3. **DVR無効ライブ**：巻き戻し不可、エッジ3秒前まで進み可
4. **✅ 現地時刻ジャンプ（キャリブレーション方式）**：
   * ✅ **Jumpボタン**からドラッグ可能カードでのアクセス確認
   * ✅ **`Alt+Shift+J`** キーボードショートカットでの表示確認
   * ✅ **キャリブレーション実装**: 6秒間・30回サンプリング・メディアン計算
   * ✅ **柔軟な時刻入力形式**（コロンあり/なし両対応）
   * ✅ **DST対応**: `Intl.DateTimeFormat`による正確な夏時間・冬時間処理
   * ✅ **エラーハンドリング**: TimeJumpResult interfaceによる詳細情報
   * ✅ **統合テスト**: 71/75テスト通過（94.7%）・型チェック完全通過
   * ✅ **UI統合**: JumpButtonUI → jumpToNetherlandsTime完全移行
   * ✅ **ドラッグ移動・位置保存・ピン留め機能**の動作確認
   * ✅ **フルスクリーン時の自動クランプ**確認

### 🔄 **要実機確認項目**
5. **広告中は動作せず通知**
6. **入力中やIME変換中はショートカット無効化**
7. **実機でのキャリブレーション精度確認**
   - YouTube Live配信での実際のオフセット測定
   - 複数の配信での精度検証
   - DST境界日での動作確認
8. **実機でのドラッグ可能カード動作**
   - 字幕回避の動作確認
   - 各ブラウザでの表示確認


## 9. 配布方法

1. ローカル開発 → `chrome://extensions` に読み込み
2. 動作確認後、ZIP化してChrome Web Storeへアップロード
3. 公開形態：

   * **Public**：全員に検索・インストール可能
   * **Unlisted**：URLを知っている人だけ
4. 更新時はバージョン番号を上げて再アップロード（ユーザーは自動更新）

