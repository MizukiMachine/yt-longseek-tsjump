# Chrome拡張「YouTube 長時間シーク & 現地時刻ジャンプ」要件&仕様

## 1. 目的
YouTube ライブ配信（特に24時間配信）や長尺動画で、長時間単位の巻き戻し/早送りや、現地（オランダ）時刻を指定してその瞬間へジャンプできるようにする

対象例：DVR有効live配信


## 2. 機能

### (A) 長時間シーク（早送り・巻き戻し）
- デフォルト：±10分、±60分（Chrome拡張機能4コマンド制限のため）
- キーボードショートカットで実行
  - (実装済み)
    - Alt+Shift+Q → -60分
    - Alt+Shift+A → -10分
    - Alt+Shift+W → +60分
    - Alt+Shift+S → +10分
  - ポイント
    - Q/A = 戻る系、W/S = 進む系でペア配置
    - Chrome拡張機能の4コマンド制限により±30分は除外
  - ユーザーは `chrome://extensions/shortcuts` で変更可能（手動設定が必要）
- 動作範囲は `video.seekable.start()` ～ `video.seekable.end()` にクランプ
- **ライブエッジ保護**：終了3秒前で自動停止（動画終了防止）
- DVR無効時は巻き戻し不可、ライブエッジ（最新位置）より先へは進めない
- 広告中は動作しない（通知表示）
- **詳細なエラー情報**：動画未検出、シーク不可、範囲外クランプ理由を提供



### (B) 「現地時刻ジャンプ」機能
- **アクセス方法**
  - **Jumpボタン**: YouTubeコントロールバー（ギア/字幕ボタン横）に配置した「Jump」ボタン
  - **キーボードショートカット**: `Alt+Shift+J` でドラッグ可能カードを表示
- 入力欄に **オランダ（Europe/Amsterdam）のローカル時刻**を入力
  - 対応形式：`HH:mm`、`HH:mm:ss`（コロン区切り）、`HHmm`、`HHmmss`（コロンなし）
  - 例：`06:00`、`14:30:45`、`0600`、`143045` 全て対応
- 実行すると、現地時刻に対応する再生位置へジャンプ
- **リアルタイム通知**: 成功・エラー・範囲調整を画面上で即座に表示
- **DST（サマータイム）対応**：タイムゾーン変換は `Europe/Amsterdam` 基準で計算
- 計算式（双方向計算対応）
  1. 現在のライブエッジのオランダ時刻 = `NL_now`
  2. 入力値のオランダ時刻 = `NL_input`
  3. 差分 Δ = 最短時間差を自動選択
     - 前方向: `NL_input - NL_now`
     - 後方向: 上記 ± 24時間
     - より短い時間差を採用（例：現在14:00で06:00入力→8時間戻る）
  4. `currentTime + Δ` にシーク（範囲外ならクランプ）
- **日付解決ルール**
  - 双方向計算により最適な時刻を自動選択（既定）
  - オプションで「Today / Yesterday」手動切替も可能
- DVR範囲外なら、範囲端に丸めて通知


## 3. 初期開発方針（タイムゾーン仕様）
- 初期はオランダ固定で開発
  - 実装・説明がシンプルになり、リリースまでの速度が上がる
- 要望や利用状況を見て、将来的にタイムゾーン選択機能を追加可能
  - 他国の配信やイベントにも対応し、汎用化できる
  - タイムゾーン一覧・DST対応を拡張する設計を視野に入れる


## 4. UI・操作仕様
- **Jumpボタン**（主要アクセス）
  - 位置：YouTubeコントロールバーの右端（設定・字幕ボタン横）
  - スタイル：YouTube標準ボタンと統一されたデザイン
  - クリックでドラッグ可能カードを表示・非表示
- **ドラッグ可能カード**（入力UI）
  - 初回表示位置：Jumpボタンの上方・右寄り（コントロールバー沿い）
  - **ドラッグ移動**：自由にプレイヤー内を移動可能、位置は `localStorage` に保存
  - **ピン留め機能**：
    - ON = 常時表示（自動フェードなし）
    - OFF = 無操作数秒後に半透明化→非表示、マウス移動で再表示
  - **字幕配慮**：初回スポーン時に下中央の字幕帯を避ける安全マージン（`bottom ≥ 90px`）
  - **フルスクリーン対応**：`.html5-video-player` 配下に設置、画面変更時に自動クランプ
- **キーボード操作**
  - `Alt+Shift+J`：カード表示・非表示、入力フィールドへフォーカス
  - `Enter`：時刻ジャンプ実行
  - `Esc`：カードを閉じる
  - 外側クリック：未ピン時のみカードを閉じる
- **アクセシビリティ**
  - カードに `role="dialog"`、`aria-label` 設定
  - Tab移動順の適切化、閉じた際の動画フォーカス復帰

## 5. オプション設定
- 長時間シークの分数（自由設定）
- 「現地時刻ジャンプ」機能の既定動作
  - 未来入力時の自動「昨日」切替オン/オフ
  - 入力形式（HH:mm、HH:mm:ss、HHmm、HHmmss対応済み）


## 6. 対象サイトと権限（最小権限設計）
```json
"permissions": ["commands", "storage", "scripting", "activeTab"],
"host_permissions": [
  "https://www.youtube.com/*",
  "https://www.youtube-nocookie.com/*"
]
```

* `<all_urls>` は使わない
* 必要な場合のみ追加（例：モバイル版YouTube、埋め込みプレイヤー）


## 7. セキュリティ／審査対策

* **CSP準拠**

  * JSは外部ファイル化（インライン禁止、`eval`禁止）
  * ライブラリは同梱（CDN直読み禁止）
* 外部API・データ送信なし（完全ローカル動作）
* 広告スキップやDVR無効回避など、YouTubeの制限を迂回する機能は実装しない
* ストア説明に「YouTube™ 非公式ツール」であることを明記


## 8. 動作確認チェックリスト

1. VODでの±シーク（端でクランプされる）
2. DVR有効ライブ：巻き戻し可／エッジ3秒前まで進み可
3. DVR無効ライブ：巻き戻し不可、エッジ3秒前まで進み可
4. 現地時刻ジャンプ：

   * Jumpボタンからドラッグ可能カードでのアクセス確認
   * `Alt+Shift+J` キーボードショートカットでの表示確認
   * オランダ時刻で双方向計算による最適な差分選択
   * 柔軟な時刻入力形式（コロンあり/なし両対応）
   * DSTの日も正しい位置に移動
   * 自動的に最短時間差を選択（例：14:00→06:00は8時間戻る）
   * DVR範囲外は端に丸め通知（詳細エラー情報付き）
   * リアルタイム成功・エラー表示の動作確認
   * ドラッグ移動・位置保存・ピン留め機能の動作確認
   * フルスクリーン時の自動クランプ確認
5. 広告中は動作せず通知
6. 入力中やIME変換中はショートカット無効化
7. **エラーハンドリング**：動画終了防止、範囲外処理の詳細通知
8. **ドラッグ可能カード**：Alt+Shift+J での表示/非表示、Enterキー対応、字幕回避


## 9. 配布方法

1. ローカル開発 → `chrome://extensions` に読み込み
2. 動作確認後、ZIP化してChrome Web Storeへアップロード
3. 公開形態：

   * **Public**：全員に検索・インストール可能
   * **Unlisted**：URLを知っている人だけ
4. 更新時はバージョン番号を上げて再アップロード（ユーザーは自動更新）

